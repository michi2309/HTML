<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Merkava</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

//setup iniziale dell'engine
var config = {
    type: Phaser.AUTO,
    width: 800,
    height: 700,
    physics: {
        default: 'arcade',
        arcade: {
            gravity: { y: 600 },
            debug: false
        }
    },
    scene: {
        preload: preload,
        create: create,
        update: update
    }
};
//condizioni di gioco iniziali
let isGameOver = false;
let score = 0;
let scoreText;
let isRefresh =false;
let hitPlayed= false;
let diePlayed=false;
let uccello;
let base;
let baseImage;
let baseHeight;
let veloci= -150;
let spawnTime = 1500;
let gameStart = false;
let game= new Phaser.Game(config);

function preload(){
    this.load.image("sfondo","./assets/sfondo.png");
    this.load.spritesheet("personaggio","./assets/idle.png", { frameWidth: 126, frameHeight: 39 });
    this.load.spritesheet("salto","./assets/hit.png", { frameWidth: 126, frameHeight: 39 });
    this.load.spritesheet("corsa","./assets/run.png", { frameWidth: 126, frameHeight: 39 });
    this.load.spritesheet("morto","./assets/death.png", { frameWidth: 126, frameHeight: 39 });
    this.load.image("piattaforma","./assets/piattaforme.png");
    this.load.image("base","./assets/base.png");
    this.load.image("gameover","./assets/gameover.png");
    this.load.image("punteggio","./assets/score.png");
    this.load.audio("punto","./assets/point.wav");
    this.load.audio("fine","./assets/die.wav");
    this.load.audio("saltos","./assets/jump.mp3");
}

function create() {
    let background = this.add.tileSprite(0,0,1920,1000, "sfondo");
    background.setOrigin(0,0);
    background.displayWidth = game.config.width;
    background.displayHeight = game.config.height;
    let baseImage = this.textures.get("base");
    let baseHeight = 125;
    let baseWidth = 1600;
    base=this.add.tileSprite(game.config.width,game.config.height ,baseWidth,baseHeight, "base");
    this.physics.add.existing(base,true);
    base.setDepth(1);
    //volendo ho questo codice per l'immagine iniziale ma non mi interessava farla
//    let startGameImage = this.add.image(game.config.width/2,game.config.height/3, "startGame");
//    startGameImage.setOrigin(0.5,0.5);
    uomo = this.physics.add.sprite(game.config.width/4,game.config.height/2, "personaggio")
    uomo.setDepth(1);
    uomo.setCollideWorldBounds(true);
    uomo.body.allowGravity = false;
    gameStart= false;
    //animazioni e movimento
    this.anims.create({
        key: 'idle',
        frames: this.anims.generateFrameNumbers('personaggio', { start: 0, end: 4 }),
        frameRate: 7,
        repeat: -1
    });
    this.anims.create({
        key: 'avanti',
        frames: this.anims.generateFrameNumbers('corsa', { start: 3, end: 8 }),
        frameRate: 5,
        repeat: 0
    });
 /*   this.anims.create({
        key: 'salta',
        frames: this.anims.generateFrameNumbers('salto', { start: 0, end: 1 }),
        frameRate: 5,
        repeat: -1
    });
*/
    this.anims.create({
        key: 'morte',
        frames: this.anims.generateFrameNumbers('morto', { start: 0, end: 4 }),
        frameRate: 6,
    });
    //qua esegue l'animazione iniziale ig
    uomo.anims.play("idle",true);
    this.input.on("pointerdown", function(pointer){
        if(gameStart) return;
        gameStart = true;
//        startGameImage.setVisible(false;)
    uomo.body.allowGravity = true;
    //le colonne da evitare (per ora e' cosi' devo decidere se poi cambiare lo stile di gioco)
    this.upperPillars = this.physics.add.group();
    this.lowerPillars = this.physics.add.group();
    this.spawnPillarPair();
    this.physics.add.colllider(uomo,this.upperPillars,hitPillar,null,this);
    this.physics.add.colllider(uomo,this.lowerPillars,hitPillar,null,this);
//    this.physics.add.colllider(uomo,this.base,hitbase,null,this); 
//testo dei punti 
    scoreText = this.add.text(game.config.width/2, 30, "0",{
        fontSize:"32px",
        fontFamily: "fantasy",
        fill:"white",
    });
    scoreText.setOrigin(0.5,0.5);
    scoreText.setDepth(1);
//  suoni
    point = this.sound.add("punto");
    colpo = this.sound.add("fine");
    fatica = this.sound.add("saltos");

    this.input.on("pointerdown", function(pointer){
        if(!isRefresh && !isGameOver){
            fatica.play()
            character.setVelocityY(-230);
        }
        isRefresh=false;
    },this);
    
    },this);
} 

function update(){
    //controlli iniziali del frame
    if(!isGameOver) base.tilePositionX+=1;
    if(!gameStart) return;
    
    let scoreIncremented = false;
    [this.upperPillars,this.lowerPillars].forEach((group)=>{
        group.children.iterate((
            pillar
        )=>)
    })
    
}
</script>

</body>
</html>